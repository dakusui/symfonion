<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MidiDeviceManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">symfonion</a> &gt; <a href="index.source.html" class="el_package">com.github.dakusui.symfonion.utils.midi</a> &gt; <span class="el_source">MidiDeviceManager.java</span></div><h1>MidiDeviceManager.java</h1><pre class="source lang-java linenums">package com.github.dakusui.symfonion.utils.midi;

import com.github.dakusui.symfonion.exceptions.ExceptionThrower;
import com.github.dakusui.valid8j_pcond.forms.Printables;

import javax.sound.midi.MidiDevice;
import javax.sound.midi.MidiSystem;
import javax.sound.midi.MidiUnavailableException;
import java.util.*;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.regex.Pattern;
import java.util.stream.Stream;

import static com.github.dakusui.symfonion.exceptions.ExceptionThrower.*;
import static com.github.dakusui.symfonion.exceptions.ExceptionThrower.ContextKey.MIDI_DEVICE_INFO;
import static com.github.dakusui.symfonion.exceptions.ExceptionThrower.ContextKey.MIDI_DEVICE_INFO_IO;
import static com.github.dakusui.symfonion.utils.Utils.onlyElement;

public class MidiDeviceManager {


  final List&lt;MidiDeviceRecord&gt; records;
  final MidiDeviceReportFormatter reportFormatter;


<span class="fc" id="L27">  public MidiDeviceManager(MidiDeviceReportFormatter formatter) {</span>
<span class="fc" id="L28">    this.reportFormatter = formatter;</span>
<span class="fc" id="L29">    this.records = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L30">  }</span>

  public MidiDeviceRecord lookUp(Predicate&lt;MidiDeviceRecord&gt; whereClause) {
<span class="fc" id="L33">    return this.find(whereClause)</span>
<span class="pc" id="L34">        .collect(onlyElement((e1, e2) -&gt; multipleMidiDevices(e1, e2, whereClause)))</span>
<span class="pc" id="L35">        .orElseThrow(() -&gt; noSuchMidiDeviceWasFound(whereClause));</span>
  }


  public static MidiDeviceManager from(MidiDeviceReportFormatter reportFormatter) {
<span class="fc" id="L40">    return from(reportFormatter, MidiUtils.streamMidiDeviceInfo());</span>
  }

  public static MidiDeviceManager from(MidiDeviceReportFormatter reportFormatter, Stream&lt;MidiDevice.Info&gt; midiDeviceInfoStream) {
<span class="fc" id="L44">    MidiDeviceManager reportComposer = new MidiDeviceManager(reportFormatter);</span>
<span class="fc" id="L45">    midiDeviceInfoStream.forEach(reportComposer::add);</span>
<span class="fc" id="L46">    return reportComposer;</span>
  }

  public static Predicate&lt;MidiDeviceRecord&gt; matchesPortNameInDefinitions(String inPortName, Map&lt;String, Pattern&gt; midiInDefinitions) {
<span class="fc" id="L50">    return midiDeviceInfoMatches(midiInDefinitions.get(inPortName));</span>
  }

  private static Predicate&lt;MidiDeviceRecord&gt; midiDeviceInfoMatches(Pattern regexForDeviceName) {
<span class="fc" id="L54">    return printablePredicate(&quot;.info.name.matches[&quot; + regexForDeviceName + &quot;]&quot;, r -&gt; regexForDeviceName.matcher(r.info().getName()).matches());</span>
  }

  public static Predicate&lt;MidiDeviceRecord&gt; isMidiDeviceForInput() {
<span class="fc" id="L58">    return printablePredicate(&quot;isMidiDeviceForInput&quot;, r -&gt; MidiUtils.isMidiDeviceForInput(r.info()));</span>
  }

  public static Predicate&lt;MidiDeviceRecord&gt; isMidiDeviceForOutput() {
<span class="fc" id="L62">    return printablePredicate(&quot;isMidiDeviceForOutput&quot;, r -&gt; MidiUtils.isMidiDeviceForOutput(r.info()));</span>
  }

  private static &lt;T&gt; Predicate&lt;T&gt; printablePredicate(String name, Predicate&lt;T&gt; p) {
<span class="fc" id="L66">    return Printables.predicate(name, p);</span>
  }

  public static MidiDeviceRecord lookUpMidiDevice(Predicate&lt;MidiDeviceRecord&gt; whereClause, MidiDeviceManager midiDeviceManager) {
<span class="fc" id="L70">    return midiDeviceManager.lookUp(whereClause);</span>
  }

  public MidiDeviceManager add(MidiDevice.Info info) {
<span class="fc" id="L74">    return this.add(MidiDeviceRecord.fromMidiDeviceInfo(info));</span>
  }

  public MidiDeviceManager add(MidiDeviceRecord record) {
<span class="fc" id="L78">    this.records.add(record);</span>
<span class="fc" id="L79">    return this;</span>
  }


  public Stream&lt;MidiDeviceRecord&gt; find(Predicate&lt;MidiDeviceRecord&gt; cond) {
<span class="fc" id="L84">    return streamRecords().filter(cond);</span>
  }

  private Stream&lt;MidiDeviceRecord&gt; streamRecords() {
<span class="fc" id="L88">    return this.records.stream();</span>
  }

  public MidiDevice openMidiDevice(MidiDeviceRecord deviceRecord) {
<span class="fc" id="L92">    try (ExceptionThrower.Context ignored = context($(MIDI_DEVICE_INFO, deviceRecord.info()), $(MIDI_DEVICE_INFO_IO, deviceRecord.io()))) {</span>
<span class="fc" id="L93">      return openMidiDevice(deviceRecord.info());</span>
    }
  }

  public MidiDevice openMidiDevice(MidiDevice.Info info) {
    try {
<span class="fc" id="L99">      MidiDevice ret = MidiSystem.getMidiDevice(info);</span>
<span class="fc" id="L100">      ret.open();</span>
<span class="fc" id="L101">      return ret;</span>
<span class="nc" id="L102">    } catch (MidiUnavailableException e) {</span>
<span class="nc" id="L103">      throw ExceptionThrower.failedToOpenMidiDevice(e);</span>
    }
  }

  public List&lt;String&gt; composeReport(Predicate&lt;MidiDeviceRecord&gt; cond, final MidiDeviceReportFormatter reportFormatter, final String title) {
<span class="fc" id="L108">    MidiDevice.Info dummyInfoForHeader = new MidiDevice.Info(&quot;name&quot;, &quot;vendor&quot;, &quot;description&quot;, &quot;version&quot;) {</span>
    };
<span class="fc" id="L110">    return new ArrayList&lt;&gt;() {</span>
      {
<span class="fc" id="L112">        this.addAll(reportFormatter.header(dummyInfoForHeader, title)</span>
<span class="fc" id="L113">            .stream()</span>
<span class="fc" id="L114">            .map(s -&gt; reportFormatter.formatResult(false, s))</span>
<span class="fc" id="L115">            .toList());</span>
<span class="fc" id="L116">        this.addAll(MidiDeviceManager.this.records</span>
<span class="fc" id="L117">            .stream()</span>
<span class="fc" id="L118">            .map(r -&gt; reportFormatter.formatResult(cond.test(r), reportFormatter.formatRecord(r)))</span>
<span class="fc" id="L119">            .toList());</span>
<span class="pc" id="L120">        this.addAll(reportFormatter.footer().stream().map(s -&gt; reportFormatter.formatResult(false, s)).toList());</span>
<span class="fc" id="L121">      }</span>
    };
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>