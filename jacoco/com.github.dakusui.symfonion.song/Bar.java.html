<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Bar.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">symfonion</a> &gt; <a href="index.source.html" class="el_package">com.github.dakusui.symfonion.song</a> &gt; <span class="el_source">Bar.java</span></div><h1>Bar.java</h1><pre class="source lang-java linenums">package com.github.dakusui.symfonion.song;

import com.github.dakusui.json.JsonException;
import com.github.dakusui.json.JsonInvalidPathException;
import com.github.dakusui.json.JsonUtils;
import com.github.dakusui.symfonion.exceptions.FractionFormatException;
import com.github.dakusui.symfonion.exceptions.SymfonionException;
import com.github.dakusui.symfonion.utils.Fraction;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;

import java.util.*;
import java.util.Map.Entry;

import static com.github.dakusui.json.JsonUtils.asJsonElement;
import static com.github.dakusui.symfonion.exceptions.ExceptionThrower.*;
import static com.github.dakusui.symfonion.exceptions.ExceptionThrower.ContextKey.JSON_ELEMENT_ROOT;
import static com.github.dakusui.symfonion.exceptions.SymfonionIllegalFormatException.FRACTION_EXAMPLE;
import static com.github.dakusui.symfonion.exceptions.SymfonionTypeMismatchException.ARRAY;

public class Bar {
  private final Map&lt;String, Groove&gt; grooves;
  private final Map&lt;String, Pattern&gt; patterns;
  private final JsonObject rootJsonObject;
  Fraction beats;
<span class="fc" id="L27">  Map&lt;String, List&lt;List&lt;Pattern&gt;&gt;&gt; patternLists = new HashMap&lt;&gt;();</span>
  Groove groove;
  private final JsonObject json;


<span class="fc" id="L32">  public Bar(JsonObject jsonObject, JsonObject root, Map&lt;String, Groove&gt; grooves, Map&lt;String, Pattern&gt; patterns) throws SymfonionException, JsonException {</span>
<span class="fc" id="L33">    this.grooves = grooves;</span>
<span class="fc" id="L34">    this.patterns = patterns;</span>
<span class="fc" id="L35">    this.json = jsonObject;</span>
<span class="fc" id="L36">    this.rootJsonObject = root;</span>
<span class="fc" id="L37">    init(jsonObject, root);</span>
<span class="fc" id="L38">  }</span>

  private void init(JsonObject jsonObject, JsonObject root) throws SymfonionException, JsonException {
<span class="fc" id="L41">    try (Context ignored = context($(JSON_ELEMENT_ROOT, root))) {</span>
      try {
<span class="fc" id="L43">        this.beats = Fraction.parseFraction(JsonUtils.asString(jsonObject, Keyword.$beats));</span>
<span class="fc" id="L44">      } catch (FractionFormatException e) {</span>
<span class="nc" id="L45">        throw illegalFormatException(asJsonElement(jsonObject, Keyword.$beats), FRACTION_EXAMPLE);</span>
<span class="fc" id="L46">      }</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">      this.beats = this.beats == null ? Fraction.one : this.beats;</span>
<span class="fc" id="L48">      this.groove = Groove.DEFAULT_INSTANCE;</span>
<span class="fc" id="L49">      Groove g = Groove.DEFAULT_INSTANCE;</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">      if (JsonUtils.hasPath(jsonObject, Keyword.$groove)) {</span>
<span class="fc" id="L51">        String grooveName = JsonUtils.asString(jsonObject, Keyword.$groove.name());</span>
<span class="fc" id="L52">        g = grooves.get(grooveName);</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">        if (g == null) {</span>
<span class="nc" id="L54">          throw grooveNotDefinedException(asJsonElement(jsonObject, Keyword.$groove), grooveName);</span>
        }
      }
<span class="fc" id="L57">      this.groove = g;</span>
<span class="fc" id="L58">      JsonObject patternsJsonObject = JsonUtils.asJsonObject(jsonObject, Keyword.$patterns);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">      if (patternsJsonObject == null) {</span>
<span class="nc" id="L60">        throw requiredElementMissingException(jsonObject, Keyword.$patterns);</span>
      }
<span class="fc bfc" id="L62" title="All 2 branches covered.">      for (Entry&lt;String, JsonElement&gt; stringJsonElementEntry : patternsJsonObject.entrySet()) {</span>
<span class="fc" id="L63">        String partName = stringJsonElementEntry.getKey();</span>
<span class="fc" id="L64">        List&lt;List&lt;Pattern&gt;&gt; patterns = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L65">        JsonArray partPatternsJsonArray = JsonUtils.asJsonArray(patternsJsonObject, partName);</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (!partPatternsJsonArray.isJsonArray()) {</span>
<span class="nc" id="L67">          throw typeMismatchException(partPatternsJsonArray, ARRAY);</span>
        }
<span class="fc" id="L69">        int len = partPatternsJsonArray.size();</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">        for (int j = 0; j &lt; len; j++) {</span>
<span class="fc" id="L71">          JsonElement jsonPatterns = partPatternsJsonArray.get(j);</span>
<span class="fc" id="L72">          String patternNames = jsonPatterns.getAsString();</span>
<span class="fc" id="L73">          List&lt;Pattern&gt; p = new LinkedList&lt;&gt;();</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">          for (String each : patternNames.split(&quot;;&quot;)) {</span>
<span class="fc" id="L75">            Pattern cur = this.patterns.get(each);</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">            if (cur == null) {</span>
<span class="nc" id="L77">              throw patternNotFound(jsonPatterns, patternNames);</span>
            }
<span class="fc" id="L79">            p.add(cur);</span>
          }
<span class="fc" id="L81">          patterns.add(p);</span>
        }
<span class="fc" id="L83">        patternLists.put(partName, patterns);</span>
<span class="fc" id="L84">      }</span>
    }
<span class="fc" id="L86">  }</span>

  public Set&lt;String&gt; partNames() {
<span class="fc" id="L89">    return Collections.unmodifiableSet(this.patternLists.keySet());</span>
  }

  public List&lt;List&lt;Pattern&gt;&gt; part(String instrumentName) {
<span class="fc" id="L93">    return Collections.unmodifiableList(this.patternLists.get(instrumentName));</span>
  }

  public Fraction beats() {
<span class="fc" id="L97">    return this.beats;</span>
  }

  public Groove groove() {
<span class="fc" id="L101">    return this.groove;</span>
  }

  public JsonElement lookUpJsonNode(String partName) {
    try {
<span class="fc" id="L106">      return asJsonElement(this.json, Keyword.$patterns, partName);</span>
<span class="nc" id="L107">    } catch (JsonInvalidPathException e) {</span>
<span class="nc" id="L108">      return null;</span>
    }
  }

  public JsonObject rootJsonObject() {
<span class="fc" id="L113">    return this.rootJsonObject;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>